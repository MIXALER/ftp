## 1 基于 epoll 的 ftp 服务器设计

因为 ftp 服务端可能同时收到大量的并发请求。目前设计的 ftp 服务端是基于 accept 实现的阻塞等待客户端连接，但是一次只能处理一个客户端的连接。如果要实现多并发的 ftp 服务端的话就要实现 I/O 复用，Linux 系统上的 I/O 复用模型有 select， poll， 和 epoll。其中 epoll 的性能最好。

基于 epoll 的 ftp 服务器因为要处理高并发的请求，因此需要创立一个线程池来处理并发请求。系统采用模块化的方式实现，具体的功能模块划分如下：

1.  监听模块

    采用 epoll 模型监听新的用户接入或命令消息到达，前者交给用户接入处理模块，后者直接放入消息队列中

2.  用户处理模块

    用户登录时交于这一模块处理，主要功能是对用户进行验证。

3.  消息处理模块

    负责命令消息的处理，需要其他模块配合工作，如下面的线程模块，用户处理模块。命令消息处理完成后即时返回给用户保持命令传输的交互性

4.  线程池模块

    负责提供线程用于消息处理以及数据传输。线程池采用动态创建与回收机制，线程池保存两个队列，工作线程队列与空闲线程队列，当空闲队列中线程数低于阈值或高于阈值时，则分配或回收一部分线程，从而在保证系统高效的同时减小系统开销。

整个系统的工作流程如下，系统启动后首先进行资源分配，读入配置文件，初始化线程池，初始化 epoll 模型并开启监听；当用户接入时，进行用户验证，若合法则把用户放如用户管理对象中；当新命令到达时，把命令放入消息队列中等待处理；系统开启若干个线程用于处理消息队列中的消息，使用信号通知，一旦消息队列非空时，则会唤醒一个空闲线程；当读到 "LIST", "RETR" 时，说明用户准备进行数据传输，则在数据传输线程池中提取一个空闲线程，修改线程数据并放到工作线程中执行，执行完毕后由线程把结果状态返回给用户并从工作状态中进入空闲状态。用户自接入成功一直处于命令交互状态，直到发送 ”QUIT" 退出。

